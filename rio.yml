schemaVersion: 2.0
timeout: 180

notify:
  email:
    enabled: false
  pullRequestComment:
    postOnSuccess: false
    postOnFailure: false

machine:
  baseImage: docker.apple.com/base-images/ubi8/java11-builder
  env: &base_env
    NOLINT_ON_COMPILE: "1"
    SPARK_LOCAL_HOSTNAME: "localhost"
    SPARK_TEST_HIVE_CLIENT_VERSIONS: "3.1,2.3"
    SBT_OPTS: "-Xms6g -Xmx6g -Xss128M -XX:MaxMetaspaceSize=2048M"
    HEADER_ACCEPTS_TGZ: "Accepts: application/x-gzip"

builds:
  - name: apple-spark-2.12_3.4.0-snapshot-dependency
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - dev/test-dependencies.sh
        - dev/mima

  - name: apple-spark-2.12_3.4.0-snapshot-dependency-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - dev/test-dependencies.sh
        - dev/mima

  - name: apple-spark-2.12_3.4.0-snapshot-common
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - BOSON=false build/sbt -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"
        - BOSON=true build/sbt -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"

  - name: apple-spark-2.13_3.4.0-snapshot-common
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"

  - name: apple-spark-2.12_3.4.0-snapshot-common-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - BOSON=false build/sbt -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"
        - BOSON=true build/sbt -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"

  - name: apple-spark-2.13_3.4.0-snapshot-common-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sketch/test" "kvstore/test" "network-common/test" "network-shuffle/test" "unsafe/test"

  - name: apple-spark-2.12_3.4.0-snapshot-core
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - BOSON=false build/sbt -Phadoop-3 "core/test"
        - BOSON=true build/sbt -Phadoop-3 "core/test"

  - name: apple-spark-2.13_3.4.0-snapshot-core
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "core/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "core/test"

  - name: apple-spark-2.12_3.4.0-snapshot-core-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - BOSON=false build/sbt -Phadoop-3 "core/test"
        - BOSON=true build/sbt -Phadoop-3 "core/test"

  - name: apple-spark-2.13_3.4.0-snapshot-core-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "core/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "core/test"

  - name: apple-spark-2.12_3.4.0-snapshot-streaming
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - BOSON=false build/sbt -Phadoop-3 "streaming/test"
        - BOSON=true build/sbt -Phadoop-3 "streaming/test"

  - name: apple-spark-2.13_3.4.0-snapshot-streaming
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming/test"

  - name: apple-spark-2.12_3.4.0-snapshot-streaming-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - BOSON=false build/sbt -Phadoop-3 "streaming/test"
        - BOSON=true build/sbt -Phadoop-3 "streaming/test"

  - name: apple-spark-2.13_3.4.0-snapshot-streaming-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming/test"

  - name: apple-spark-2.12_3.4.0-snapshot-mllib
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"

  - name: apple-spark-2.13_3.4.0-snapshot-mllib
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"

  - name: apple-spark-2.12_3.4.0-snapshot-mllib-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "mllib/test" "mllib-local/test"

  - name: apple-spark-2.13_3.4.0-snapshot-mllib-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "mllib/test" "mllib-local/test"

  - name: apple-spark-2.12_3.4.0-snapshot-graphx
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - BOSON=false build/sbt -Phadoop-3 "graphx/test"
        - BOSON=true build/sbt -Phadoop-3 "graphx/test"

  - name: apple-spark-2.13_3.4.0-snapshot-graphx
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "graphx/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "graphx/test"

  - name: apple-spark-2.12_3.4.0-snapshot-graphx-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - BOSON=false build/sbt -Phadoop-3 "graphx/test"
        - BOSON=true build/sbt -Phadoop-3 "graphx/test"

  - name: apple-spark-2.13_3.4.0-snapshot-graphx-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "graphx/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "graphx/test"

  - name: apple-spark-2.12_3.4.0-snapshot-catalyst
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "catalyst/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "catalyst/test"

  - name: apple-spark-2.13_3.4.0-snapshot-catalyst
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"

  - name: apple-spark-2.12_3.4.0-snapshot-catalyst-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "catalyst/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "catalyst/test"

  - name: apple-spark-2.13_3.4.0-snapshot-catalyst-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "catalyst/test"

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-boson # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-ucauthz
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-boson-ucauthz # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-boson # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-ucauthz
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-boson-ucauthz # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-boson-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-ucauthz-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-1-boson-ucauthz-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-boson-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-ucauthz-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-1-boson-ucauthz-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # PythonUDFSuite
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-2
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install pandas==1.4.1 pyarrow==7.0.0 # SQLQueryTestSuite
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-2
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install pandas==1.4.1 pyarrow==7.0.0 # SQLQueryTestSuite
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-sql-2-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install pandas==1.4.1 pyarrow==7.0.0 # SQLQueryTestSuite
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.13_3.4.0-snapshot-sql-2-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install pandas==1.4.1 pyarrow==7.0.0 # SQLQueryTestSuite
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "sql/test" -Dtest.include.tags=org.apache.spark.tags.ExtendedSQLTest

  - name: apple-spark-2.12_3.4.0-snapshot-hadoop-cloud
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"

  - name: apple-spark-2.13_3.4.0-snapshot-hadoop-cloud
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"

  - name: apple-spark-2.12_3.4.0-snapshot-hadoop-cloud-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"

  - name: apple-spark-2.13_3.4.0-snapshot-hadoop-cloud-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phadoop-cloud "hadoop-cloud/test"

  - name: apple-spark-2.12_3.4.0-snapshot-hive-1
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # HiveScriptTransformationSuite
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest

  - name: apple-spark-2.13_3.4.0-snapshot-hive-1
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # HiveScriptTransformationSuite
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest

  - name: apple-spark-2.12_3.4.0-snapshot-hive-1-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # HiveScriptTransformationSuite
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest

  - name: apple-spark-2.13_3.4.0-snapshot-hive-1-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # HiveScriptTransformationSuite
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/test" -Dtest.exclude.tags=org.apache.spark.tags.ExtendedHiveTest

  - name: apple-spark-2.12_3.4.0-snapshot-hive-2
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - UCAUTHZ=false BOSON=false PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"
        - UCAUTHZ=false BOSON=true PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"
        - UCAUTHZ=true BOSON=false PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"
        - UCAUTHZ=true BOSON=true PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"

  - name: apple-spark-2.13_3.4.0-snapshot-hive-2
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite
        - UCAUTHZ=false BOSON=true PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite
        - UCAUTHZ=true BOSON=false PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite
        - UCAUTHZ=true BOSON=true PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite

  - name: apple-spark-2.12_3.4.0-snapshot-hive-2-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - UCAUTHZ=false BOSON=false PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"
        - UCAUTHZ=false BOSON=true PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"
        - UCAUTHZ=true BOSON=false PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"
        - UCAUTHZ=true BOSON=true PYSPARK_PYTHON=python3 build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveExternalCatalogVersionsSuite" "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite"

  - name: apple-spark-2.13_3.4.0-snapshot-hive-2-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite
        - UCAUTHZ=false BOSON=true PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite
        - UCAUTHZ=true BOSON=false PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite
        - UCAUTHZ=true BOSON=true PYSPARK_PYTHON=python3 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveSparkSubmitSuite" "hive/testOnly *.VersionsSuite" "hive/testOnly *.HiveDDLSuite" "hive/testOnly *.HiveCatalogedDDLSuite" "hive/testOnly *.Hive_2_1_DDLSuite" "hive/testOnly *.HiveQuerySuite" "hive/testOnly *.SQLQuerySuite" # skip HiveExternalCatalogVersionsSuite

  - name: apple-spark-2.12_3.4.0-snapshot-hive-3
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"

  - name: apple-spark-2.13_3.4.0-snapshot-hive-3
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"

  - name: apple-spark-2.12_3.4.0-snapshot-hive-3-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"

  - name: apple-spark-2.13_3.4.0-snapshot-hive-3-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive "hive/testOnly *.HiveCompatibilitySuite"

  - name: apple-spark-2.12_3.4.0-snapshot-iceberg-spark-test-jars
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - build/mvn -Phadoop-3 -Phive -Piceberg -Dtest="org/apache/iceberg/*" -DwildcardSuites=none test

  - name: apple-spark-2.12_3.4.0-snapshot-iceberg-spark-test-jars-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - build/mvn -Phadoop-3 -Phive -Piceberg -Dtest="org/apache/iceberg/*" -DwildcardSuites=none test

  - name: apple-spark-2.12_3.4.0-snapshot-iceberg
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - export NEW_VERSION="$(sed -n '29s/<version>\(.*\)<\/version>/\1/p' pom.xml | xargs)-iceberg"
        - build/mvn versions:set -DnewVersion="$NEW_VERSION" -DgenerateBackupPoms=false
        - build/mvn install -Phive -Piceberg -Phadoop-3 -DskipTests
        - git clone git@github.pie.apple.com:IPR/apache-incubator-iceberg.git
        - cd apache-incubator-iceberg
        - git checkout -b apple-1.3.0.x origin/apple-1.3.0.x
        - sed -i "s/sparkVersion = \(.*\)/sparkVersion = '${NEW_VERSION}'/g" spark/v3.4/build.gradle
        - sed -i "s/org\.apache\.hive:\* = \(.*\)/org\.apache\.hive:\* = $(sed -n 's/<hive\.version>\(.*\)<\/hive\.version>/\1/p' ../pom.xml | xargs)/g" versions.props
        - ./gradlew test

  - name: apple-spark-2.12_3.4.0-snapshot-iceberg-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - export NEW_VERSION="$(sed -n '29s/<version>\(.*\)<\/version>/\1/p' pom.xml | xargs)-iceberg"
        - build/mvn versions:set -DnewVersion="$NEW_VERSION" -DgenerateBackupPoms=false
        - build/mvn install -Phive -Piceberg -Phadoop-3 -DskipTests
        - git clone git@github.pie.apple.com:IPR/apache-incubator-iceberg.git
        - cd apache-incubator-iceberg
        - git checkout -b apple-1.3.0.x origin/apple-1.3.0.x
        - sed -i "s/sparkVersion = \(.*\)/sparkVersion = '${NEW_VERSION}'/g" spark/v3.4/build.gradle
        - sed -i "s/org\.apache\.hive:\* = \(.*\)/org\.apache\.hive:\* = $(sed -n 's/<hive\.version>\(.*\)<\/hive\.version>/\1/p' ../pom.xml | xargs)/g" versions.props
        - ./gradlew test

  - name: apple-spark-2.12_3.4.0-snapshot-iceberg-hive-test-jars
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - build/mvn -Phadoop-3 -Phive -Piceberg -Dtest="org/apache/iceberg/hive/*" -DwildcardSuites=none test

  - name: apple-spark-2.12_3.4.0-snapshot-iceberg-hive-test-jars-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - build/mvn -Phadoop-3 -Phive -Piceberg -Dtest="org/apache/iceberg/hive/*" -DwildcardSuites=none test

  - name: apple-spark-2.12_3.4.0-snapshot-launcher-repl-tools
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"

  - name: apple-spark-2.13_3.4.0-snapshot-launcher-repl-tools
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"

  - name: apple-spark-2.12_3.4.0-snapshot-launcher-repl-tools-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "launcher/test" "repl/test" "tools/test"

  - name: apple-spark-2.13_3.4.0-snapshot-launcher-repl-tools-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "launcher/test" "repl/test" "tools/test"

  - name: apple-spark-2.12_3.4.0-snapshot-hive-thriftserver
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=false BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver

  - name: apple-spark-2.13_3.4.0-snapshot-hive-thriftserver
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=false BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver

  - name: apple-spark-2.12_3.4.0-snapshot-hive-thriftserver-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=false BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver

  - name: apple-spark-2.13_3.4.0-snapshot-hive-thriftserver-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=false BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=false SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver
        - UCAUTHZ=true BOSON=true SERIAL_SBT_TESTS=1 build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "hive-thriftserver/test" -Phive -Phive-thriftserver

  - name: apple-spark-2.12_3.4.0-snapshot-kafka
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"

  - name: apple-spark-2.13_3.4.0-snapshot-kafka
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"

  - name: apple-spark-2.12_3.4.0-snapshot-kafka-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"

  - name: apple-spark-2.13_3.4.0-snapshot-kafka-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "streaming-kafka-0-10/test" "sql-kafka-0-10/test" "token-provider-kafka-0-10/test"

  - name: apple-spark-2.12_3.4.0-snapshot-kinesis
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"

  - name: apple-spark-2.13_3.4.0-snapshot-kinesis
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"

  - name: apple-spark-2.12_3.4.0-snapshot-kinesis-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"

  - name: apple-spark-2.13_3.4.0-snapshot-kinesis-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pkinesis-asl "streaming-kinesis-asl/test"

  - name: apple-spark-2.12_3.4.0-snapshot-avro
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "avro/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "avro/test"

  - name: apple-spark-2.13_3.4.0-snapshot-avro
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"

  - name: apple-spark-2.12_3.4.0-snapshot-avro-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phadoop-3 "avro/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phadoop-3 "avro/test"

  - name: apple-spark-2.13_3.4.0-snapshot-avro-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 "avro/test"

  - name: apple-spark-2.12_3.4.0-snapshot-connect
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - UCAUTHZ=false BOSON=false build/sbt -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"
        - UCAUTHZ=false BOSON=true build/sbt -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"
        - UCAUTHZ=true BOSON=false build/sbt -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"
        - UCAUTHZ=true BOSON=true build/sbt -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"

  - name: apple-spark-2.13_3.4.0-snapshot-connect
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - dev/change-scala-version.sh 2.13
        - UCAUTHZ=false BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"
        - UCAUTHZ=false BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"
        - UCAUTHZ=true BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"
        - UCAUTHZ=true BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phive -Phadoop-3 assembly/package "protobuf/test" "connect-common/test" "connect/test" "connect-client-jvm/test"

  - name: apple-spark-2.12_3.4.0-snapshot-yarn-k8s
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # YarnClusterSuite needs python3
        - BOSON=false build/sbt -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"
        - BOSON=true build/sbt -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"

  - name: apple-spark-2.13_3.4.0-snapshot-yarn-k8s
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39 # YarnClusterSuite needs python3
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"

  - name: apple-spark-2.12_3.4.0-snapshot-yarn-k8s-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # YarnClusterSuite needs python3
        - BOSON=false build/sbt -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"
        - BOSON=true build/sbt -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"

  - name: apple-spark-2.13_3.4.0-snapshot-yarn-k8s-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39 # YarnClusterSuite needs python3
        - dev/change-scala-version.sh 2.13
        - BOSON=false build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"
        - BOSON=true build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Pyarn -Pkubernetes "yarn/test" "kubernetes/test"

  - name: apple-spark-2.12_3.4.0-snapshot-python39
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-boson # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-ucauthz
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-boson-ucauthz # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-boson # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-ucauthz
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-boson-ucauthz # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:build
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-boson-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-ucauthz-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot-python39-boson-ucauthz-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - build/sbt -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-boson-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=false BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-ucauthz-pr
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=false python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.13_3.4.0-snapshot-python39-boson-ucauthz-pr # long-running test has its own Boson tests
    branchName: branch-3.4.0-apple
    build:
      template: freestyle:v4:prb
      steps:
        - yum install -q -y python39
        - pip3.9 install numpy==1.22.3 scipy==1.8.0 pandas==1.4.1 pyarrow==7.0.0 openpyxl==3.0.10 "jinja2<3.0.0" markupsafe==2.0.1 grpcio==1.48.1 grpcio-status==1.48.1 protobuf==3.19.5 googleapis-common-protos==1.56.4
        - dev/change-scala-version.sh 2.13
        - build/sbt -Dscala.version=2.13.8 -Pscala-2.13 -Phadoop-3 -Phive test:package
        - UCAUTHZ=true BOSON=true python/run-tests.py --python-executables python3.9 --parallelism 3

  - name: apple-spark-2.12_3.4.0-snapshot
    branchName: branch-3.4.0-apple
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.12"
        SCALA_VERSION: "2.12.17"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: true
        MAVEN_OPTS: "-Xms6g -Xmx6g -Xss128M -XX:MaxMetaspaceSize=3g"
    build:
      template: freestyle:v4:publish
      steps:
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --snapshot --maven-opts "${MAVEN_OPTS}" --maven-params "-P hive,hadoop-${HADOOP_BINARY_VERSION},hadoop-cloud,hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,code-profiler"
        - ci stage-lib --many-many-artifacts ".dist/local-repo/**/*.jar"
        - ci stage-lib --many-many-artifacts ".dist/local-repo/**/*.pom"
    package:
      freeform:
      - publish:
        - repo: m2:oss-patched

  - name: apple-spark-2.13_3.4.0-snapshot
    branchName: branch-3.4.0-apple
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.13"
        SCALA_VERSION: "2.13.8"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: true
        MAVEN_OPTS: "-Xms6g -Xmx6g -Xss128M -XX:MaxMetaspaceSize=3g"
    build:
      template: freestyle:v4:publish
      steps:
        - dev/change-scala-version.sh 2.13
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --snapshot --maven-opts "${MAVEN_OPTS}" --maven-params "-Dscala.version=$SCALA_VERSION -P scala-${SCALA_BINARY_VERSION},hive,hadoop-${HADOOP_BINARY_VERSION},hadoop-cloud,hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,code-profiler"
        - ci stage-lib --many-many-artifacts ".dist/local-repo/**/*.jar"
        - ci stage-lib --many-many-artifacts ".dist/local-repo/**/*.pom"
    package:
      freeform:
      - publish:
        - repo: m2:oss-patched

  - name: apple-spark-2.12_3.4.0-binaries-snapshot
    branchName: branch-3.4.0-apple
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.12"
        SCALA_VERSION: "2.12.17"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: false
        MAVEN_OPTS: "-Xms12g -Xmx12g -Xss128M -XX:MaxMetaspaceSize=4g"
    build:
      template: freestyle:v4:publish
      steps:
        - yum install -q -y python39
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --snapshot --maven-opts "${MAVEN_OPTS}" --maven-params "-P hive,hadoop-cloud,hadoop-${HADOOP_BINARY_VERSION},hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,connect,code-profiler"
        - ./dev/make-distribution.sh --tgz --pip --use-existing-build --with-hadoop --skip-java-test -DskipTests=true -Dscala-$SCALA_BINARY_VERSION=enabled -Dhive-thriftserver=enabled -Dscala.version="$SCALA_VERSION" -Dscala.binary.version="$SCALA_BINARY_VERSION" -Phadoop-${HADOOP_BINARY_VERSION}
        - ci stage-lib ".dist/local-repo/**/*.tgz,snapshot"
    package:
      freeform:
      - publish:
        - repo: oss-patched-binaries-local
    finally:
      pipelineChain:
        - pipeline: image-branch-3.4.0-apple-publish-2.12_3.4.0

  - name: apple-spark-2.13_3.4.0-binaries-snapshot
    branchName: branch-3.4.0-apple
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.13"
        SCALA_VERSION: "2.13.8"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: false
        MAVEN_OPTS: "-Xms12g -Xmx12g -Xss128M -XX:MaxMetaspaceSize=4g"
    build:
      template: freestyle:v4:publish
      steps:
        - dev/change-scala-version.sh 2.13
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --snapshot --maven-opts "${MAVEN_OPTS}" --maven-params "-Dscala.version=$SCALA_VERSION -P scala-${SCALA_BINARY_VERSION},hive,hadoop-cloud,hadoop-${HADOOP_BINARY_VERSION},hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,connect,code-profiler"
        - ./dev/make-distribution.sh --tgz --use-existing-build --with-hadoop --skip-java-test -DskipTests=true -Dscala-$SCALA_BINARY_VERSION=enabled -Dhive-thriftserver=enabled -Dscala.version="$SCALA_VERSION" -Dscala.binary.version="$SCALA_BINARY_VERSION" -Pscala-$SCALA_BINARY_VERSION -Phadoop-${HADOOP_BINARY_VERSION}
        - ci stage-lib ".dist/local-repo/**/*.tgz,snapshot"
    package:
      freeform:
      - publish:
        - repo: oss-patched-binaries-local
    finally:
      pipelineChain:
        - pipeline: image-branch-3.4.0-apple-publish-2.13_3.4.0

  - name: apple-spark-2.12_3.4.0-release
    branchName: branch-3.4.0-apple-release
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.12"
        SCALA_VERSION: "2.12.17"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: true
        MAVEN_OPTS: "-Xms12g -Xmx12g -Xss128M -XX:MaxMetaspaceSize=4g"
    build:
      template: freestyle:v4:publish
      steps:
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --release --maven-opts "${MAVEN_OPTS}" --maven-params "-P hive,hadoop-cloud,hadoop-${HADOOP_BINARY_VERSION},hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,code-profiler"
        - ci stage-lib --many-many-artifacts ".dist/local-repo/**/*" --exclude "**/*.xml" --exclude "**/*.md5" --exclude "**/*.sha1"
    package:
      release: true
      freeform:
      - publish:
        - repo: m2:oss-patched
    finally:
      tag:
        enabled: true
        expression: "releases_2.12/3.4.0.48-apple"

  - name: apple-spark-2.13_3.4.0-release
    branchName: branch-3.4.0-apple-release
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.13"
        SCALA_VERSION: "2.13.8"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: true
        MAVEN_OPTS: "-Xms12g -Xmx12g -Xss128M -XX:MaxMetaspaceSize=4g"
    build:
      template: freestyle:v4:publish
      steps:
        - dev/change-scala-version.sh 2.13
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --release --maven-opts "${MAVEN_OPTS}" --maven-params "-Dscala.version=$SCALA_VERSION -P scala-${SCALA_BINARY_VERSION},hive,hadoop-cloud,hadoop-${HADOOP_BINARY_VERSION},hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,code-profiler"
        - ci stage-lib --many-many-artifacts ".dist/local-repo/**/*" --exclude "**/*.xml" --exclude "**/*.md5" --exclude "**/*.sha1"
    package:
      release: true
      freeform:
      - publish:
        - repo: m2:oss-patched
    finally:
      tag:
        enabled: true
        expression: "releases_2.13/3.4.0.48-apple"

  - name: apple-spark-2.12_3.4.0-binaries-release
    branchName: branch-3.4.0-apple-release
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.12"
        SCALA_VERSION: "2.12.17"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: false
        MAVEN_OPTS: "-Xms12g -Xmx12g -Xss128M -XX:MaxMetaspaceSize=4g"
    build:
      template: freestyle:v4:publish
      steps:
        - yum install -q -y python39
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --release --maven-opts "${MAVEN_OPTS}" --maven-params "-P hive,hadoop-cloud,hadoop-${HADOOP_BINARY_VERSION},hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,connect,code-profiler"
        - ./dev/make-distribution.sh --tgz --pip --use-existing-build --with-hadoop --skip-java-test -DskipTests=true -Dscala-$SCALA_BINARY_VERSION=enabled -Dhive-thriftserver=enabled -Dscala.version="$SCALA_VERSION" -Dscala.binary.version="$SCALA_BINARY_VERSION" -Phadoop-${HADOOP_BINARY_VERSION}
        - ci stage-lib ".dist/local-repo/**/*.tgz"
    package:
      freeform:
      - publish:
        - repo: oss-patched-binaries-local
    finally:
      pipelineChain:
        - pipeline: image-branch-3.4.0-apple-release-publish-2.12_3.4.0

  - name: apple-spark-2.13_3.4.0-binaries-release
    branchName: branch-3.4.0-apple-release
    timeout: 120
    machine:
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.13"
        SCALA_VERSION: "2.13.8"
        HADOOP_BINARY_VERSION: "3"
        PUBLISH_JARS: false
        MAVEN_OPTS: "-Xms12g -Xmx12g -Xss128M -XX:MaxMetaspaceSize=4g"
    build:
      template: freestyle:v4:publish
      steps:
        - dev/change-scala-version.sh 2.13
        - ./dev/rio-maven-custom-build.sh --scala "$SCALA_BINARY_VERSION" --release --maven-opts "${MAVEN_OPTS}" --maven-params "-Dscala.version=$SCALA_VERSION -P scala-${SCALA_BINARY_VERSION},hive,hadoop-cloud,hadoop-${HADOOP_BINARY_VERSION},hive-thriftserver,kinesis-asl,yarn,kubernetes,volcano,connect,code-profiler"
        - ./dev/make-distribution.sh --tgz --use-existing-build --with-hadoop --skip-java-test -DskipTests=true -Dscala-$SCALA_BINARY_VERSION=enabled -Dhive-thriftserver=enabled -Dscala.version="$SCALA_VERSION" -Dscala.binary.version="$SCALA_BINARY_VERSION" -Pscala-$SCALA_BINARY_VERSION -Phadoop-${HADOOP_BINARY_VERSION}
        - ci stage-lib ".dist/local-repo/**/*.tgz"
    package:
      freeform:
      - publish:
        - repo: oss-patched-binaries-local
    finally:
      pipelineChain:
        - pipeline: image-branch-3.4.0-apple-release-publish-2.13_3.4.0

  - group: image
    branchName: branch-3.4.0-apple-release
    version: 2.12_3.4.0
    trigger:
      gitPush: false
    machine:
      targetPlatforms:
        - linux/amd64
        - linux/arm64
      resources:
        size: xlarge
      executor:
        type: moes
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.12"
        # You need to add the following 6 env vars for Rio 3
        HTTP_PROXY: "http://proxy.config.pcp.local:3128"
        HTTPS_PROXY: "http://proxy.config.pcp.local:3128"
        http_proxy: "http://proxy.config.pcp.local:3128"
        https_proxy: "http://proxy.config.pcp.local:3128"
        NO_PROXY: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
        no_proxy: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
    build: &release_image_build
      template: freestyle:v4:publish
      buildParameters:
        - parameter: SPARK_ARTIFACT
          description: The SPARK_ARTIFACT that would have been extracted from the RIO_CONTEXT_FILE (See the previous failed runs output)
          defaultValue: ""
      steps:
        # Use the upstream published Boson
        - if [ ! -z "${RIO_CONTEXT_FILE}" ]; then SPARK_ARTIFACT=$(cat $RIO_CONTEXT_FILE | jq -r '.[0].artifacts[] | select (.name | startswith("spark-distribution_")) | .url' | grep -e '-apple[0-9.-]*\.tgz$' | head -1); fi
        - echo "SPARK_ARTIFACT = ${SPARK_ARTIFACT:=${BUILD_PARAM_SPARK_ARTIFACT}}"
        - if [ -z "${SPARK_ARTIFACT}" ]; then echo 'SPARK_ARTIFACT is required!'; exit 1; fi

        # Remove any previous distribution
        - rm -rf spark-* dist
        - wget --header="${HEADER_ACCEPTS_TGZ}" -O - $SPARK_ARTIFACT | tar -xz
        - mv -v spark-3.4* dist
    package: &release_image_package
      release: true
      dockerfile:
        - dockerfilePath: dist/kubernetes/dockerfiles/spark/Dockerfile
          context: dist
          perApplication: false
          version: "3.4"
          publish:
            - repo: docker.apple.com/spark-dev/spark_${SCALA_BINARY_VERSION}

  - group: image
    branchName: branch-3.4.0-apple-release
    version: 2.13_3.4.0
    trigger:
      gitPush: false
    machine:
      targetPlatforms:
        - linux/amd64
        - linux/arm64
      resources:
        size: xlarge
      executor:
        type: moes
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.13"
        # You need to add the following 6 env vars for Rio 3
        HTTP_PROXY: "http://proxy.config.pcp.local:3128"
        HTTPS_PROXY: "http://proxy.config.pcp.local:3128"
        http_proxy: "http://proxy.config.pcp.local:3128"
        https_proxy: "http://proxy.config.pcp.local:3128"
        NO_PROXY: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
        no_proxy: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
    build:
      <<: *release_image_build
    package:
      <<: *release_image_package

  - group: image
    branchName: branch-3.4.0-apple
    version: 2.12_3.4.0
    trigger:
      gitPush: false
    machine:
      targetPlatforms:
        - linux/amd64
        - linux/arm64
      resources:
        size: xlarge
      executor:
        type: moes
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.12"
        # You need to add the following 6 env vars for Rio 3
        HTTP_PROXY: "http://proxy.config.pcp.local:3128"
        HTTPS_PROXY: "http://proxy.config.pcp.local:3128"
        http_proxy: "http://proxy.config.pcp.local:3128"
        https_proxy: "http://proxy.config.pcp.local:3128"
        NO_PROXY: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
        no_proxy: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
    build:
      <<: *release_image_build
    package: &snapshot_image_package
      release: true
      dockerfile:
        - dockerfilePath: dist/kubernetes/dockerfiles/spark/Dockerfile
          context: dist
          perApplication: false
          version: "3.4-snapshot"
          publish:
            - repo: docker.apple.com/spark-dev/spark_${SCALA_BINARY_VERSION}

  - group: image
    branchName: branch-3.4.0-apple
    version: 2.13_3.4.0
    trigger:
      gitPush: false
    machine:
      targetPlatforms:
        - linux/amd64
        - linux/arm64
      resources:
        size: xlarge
      executor:
        type: moes
      env:
        <<: *base_env
        SCALA_BINARY_VERSION: "2.13"
        # You need to add the following 6 env vars for Rio 3
        HTTP_PROXY: "http://proxy.config.pcp.local:3128"
        HTTPS_PROXY: "http://proxy.config.pcp.local:3128"
        http_proxy: "http://proxy.config.pcp.local:3128"
        https_proxy: "http://proxy.config.pcp.local:3128"
        NO_PROXY: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
        no_proxy: "localhost,127.0.0.1,10.100.0.0/16,*.internal,*.apple.com,internal,apple.com"
    build:
      <<: *release_image_build
    package:
      <<: *snapshot_image_package
